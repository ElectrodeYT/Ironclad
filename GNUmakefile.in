# Makefile.in: Template for the project's generated Makefile.
# Copyright (C) 2021 streaksu
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.

# Some useful constants.
override KERNEL    := ironclad
override IMAGE     := ironclad.iso
override CMAGENTA  := $(shell tput setaf 5)
override CRESET    := $(shell tput sgr0)
override SOURCEDIR := source
override TESTDIR   := test

# Limine.
override LIMINE_URL  := https://github.com/limine-bootloader/limine.git
override LIMINE_DIR  := limine
override LIMINE_VERS := v2.0-branch-binary

# Directories for install.
DESTDIR ?=
PREFIX  ?= @prefix@

# Set compilers and flags with the help of autoconf.
ADAC      ?= @ADAC@
ADAFLAGS  ?= @ADAFLAGS@
ASFLAGS   ?= @ASFLAGS@
LDFLAGS   ?= @LDFLAGS@
QEMU      ?= @QEMU@
QEMUFLAGS ?= @QEMUFLAGS@
ifeq ($(origin AS), default)
    AS := @AS@
endif
ifeq ($(origin LD), default)
    LD := @LD@
endif

# Hard flags, that is, the user flags and the ones we forcefully need.
override ADAHARDFLAGS  := $(ADAFLAGS) -fpie -mno-sse -mno-sse2 -mno-red-zone \
	-fno-stack-protector -gnatec=$(SOURCEDIR)/pragmas.adc
override ASHARDFLAGS   := $(ASFLAGS)
override LDHARDFLAGS   := $(LDFLAGS) -nostdlib -pie -zmax-page-size=0x1000
override QEMUHARDFLAGS := $(QEMUFLAGS)

# Source to compile.
override ADABODIES := $(shell find $(SOURCEDIR) -type f -name '*.adb')
override ADASPECS  := $(shell find $(SOURCEDIR) -type f -name '*.ads')
override ADAOBJ    := $(shell comm -13 <(echo $(ADABODIES:.adb=.o)) <(echo $(ADASPECS:.ads=.o)))
override ASMSOURCE := $(shell find $(SOURCEDIR) -type f -name '*.S')
override OBJ       := $(ADAOBJ) $(ASMSOURCE:.S=.o)

# Where the fun begins!
.PHONY: all test clean distclean maintainer-clean install install-strip uninstall

all: $(KERNEL)

$(KERNEL): $(OBJ)
	@echo "$(CMAGENTA)$(LD)$(CRESET) $@"
	@$(LD) $(LDHARDFLAGS) $(OBJ) -T $(SOURCEDIR)/linker.ld -o $@

%.o: %.adb
	@echo "$(CMAGENTA)$(ADAC)$(CRESET) $<"
	@$(ADAC) $(ADAHARDFLAGS) -I$(SOURCEDIR)/arch -I$(SOURCEDIR)/devices \
		-I$(SOURCEDIR)/fs -I$(SOURCEDIR)/lib -I$(SOURCEDIR)/memory      \
		-I$(SOURCEDIR)/userland -I$(SOURCEDIR) -c $< -o $@

%.o: %.ads
	@echo "$(CMAGENTA)$(ADAC)$(CRESET) $<"
	@$(ADAC) $(ADAHARDFLAGS) -I$(SOURCEDIR)/arch -I$(SOURCEDIR)/devices \
		-I$(SOURCEDIR)/fs -I$(SOURCEDIR)/lib -I$(SOURCEDIR)/memory      \
		-I$(SOURCEDIR)/userland -I$(SOURCEDIR) -c $< -o $@

%.o: %.S
	@echo "$(CMAGENTA)$(AS)$(CRESET) $@"
	@$(AS) $(ASHARDFLAGS) -I$(SOURCEDIR) -c $< -o $@

test: $(IMAGE)
	@$(QEMU) $(QEMUHARDFLAGS) -hda $(IMAGE)

$(IMAGE): $(KERNEL) $(LIMINE_DIR)
	@mkdir -p iso_root
	@cp $(KERNEL) $(TESTDIR)/limine.cfg $(LIMINE_DIR)/limine.sys \
		$(LIMINE_DIR)/limine-cd.bin $(LIMINE_DIR)/limine-eltorito-efi.bin iso_root/
	@xorriso -as mkisofs -b limine-cd.bin -no-emul-boot -boot-load-size 4  \
		-boot-info-table --efi-boot limine-eltorito-efi.bin -efi-boot-part \
		--efi-boot-image iso_root --protective-msdos-label -o $(IMAGE)
	@$(LIMINE_DIR)/limine-install $(IMAGE)
	@rm -rf iso_root

$(LIMINE_DIR):
	@git clone --depth=1 --branch=$(LIMINE_VERS) $(LIMINE_URL) $(LIMINE_DIR)
	@make -C $(LIMINE_DIR)

clean:
	@rm -rf $(OBJ) $(KERNEL) $(IMAGE)
	@find $(SOURCEDIR) -name "*.ali" -type f -delete

distclean: clean
	@rm -rf $(LIMINE_DIR) GNUmakefile config.log config.status $(SOURCEDIR)/config.ads

maintainer-clean: distclean
	@rm -rf configure install-sh autom4te* *'~'

install: $(KERNEL)
	@@INSTALL@ -d "$(DESTDIR)$(PREFIX)"
	@@INSTALL@ $(KERNEL) "$(DESTDIR)$(PREFIX)"

install-strip: $(KERNEL)
	@@INSTALL@ -d "$(DESTDIR)$(PREFIX)"
	@@INSTALL@ -s $(KERNEL) "$(DESTDIR)$(PREFIX)"

uninstall:
	@rm -rf "$(DESTDIR)$(PREFIX)/$(KERNEL)"
